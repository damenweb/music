<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–≤–µ—Ç–Ω–∏—Ü–∞ - Quiz</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #121212; color: white; font-family: 'Roboto', sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .box { background: #1e1e1e; padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; border: 1px solid #333; }
        .info-bar { display: flex; justify-content: space-between; margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 8px; font-size: 14px; border: 1px solid #333; }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #2b2b2b; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #0078d4; border: none; color: white; font-weight: bold; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 5px; }
        button:disabled { background: #333; color: #777; }
        .btn-skip { background: transparent; border: 1px solid #555; color: #aaa; margin-top: 10px; }
        #status { margin-top: 15px; font-size: 0.9em; color: #aaa; min-height: 3em; }
        #player-timer { font-size: 64px; font-weight: bold; color: #0078d4; margin: 10px 0; font-family: monospace; }
        #pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99; display: none; align-items: center; justify-content: center; border-radius: 15px; }
    </style>
</head>
<body>

    <div id="auth-screen" class="box">
        <h2>–í—Ö–æ–¥ –≤ Quiz</h2>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="tryLogin()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="game-screen" class="box hidden">
        <div id="pause-overlay"><h1 style="color: #ffeb3b">–ü–ê–£–ó–ê</h1></div>
        <div class="info-bar">
            <div>TRACK: <span id="track-val">--</span></div>
            <div id="display-name" style="color: #0078d4;"></div>
        </div>
        <div id="lvl-badge" style="color:#D4AF37; font-weight:bold;">–û–ñ–ò–î–ê–ù–ò–ï</div>
        <div id="player-timer">00</div>
        <input type="text" id="pArtist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å...">
        <input type="text" id="pSong" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏...">
        <button id="sendBtn" onclick="send()" disabled>–û–¢–ü–†–ê–í–ò–¢–¨</button>
        <button id="skipBtn" class="btn-skip" onclick="skip()" disabled>–ù–µ –∑–Ω–∞—é (–°–∫–∏–ø)</button>
        <div id="status">–ñ–¥–µ–º –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞...</div>
    </div>

    <script>
        const S_URL = 'https://gatadttzyeusozvkwvai.supabase.co';
        const S_KEY = 'sb_publishable_cwXp1mw42C6sDXoeszY8sw_lYrAAefY';
        const supabaseClient = supabase.createClient(S_URL, S_KEY);

        let myLogin = "", myNick = localStorage.getItem('quiz_player_nickname');
        let timerId, hasAnsweredPermanently = false, currentSong = -1;

        async function tryLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const { data } = await supabaseClient.from('quiz_users').select('*').eq('username', u).eq('password', p).single();
            if (data) { 
                myLogin = u; 
                if(!myNick) { myNick = prompt("–¢–≤–æ–µ –∏–º—è:"); localStorage.setItem('quiz_player_nickname', myNick); }
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('display-name').innerText = myNick;
                supabaseClient.channel('quiz_chat').track({ user: myLogin, nickname: myNick });
            }
        }

        async function send() {
            const a = document.getElementById('pArtist').value.trim();
            const s = document.getElementById('pSong').value.trim();
            if(!a && !s) return;
            hasAnsweredPermanently = true;
            submit(`${a} | ${s}`, "–û—Ç–≤–µ—Ç –ø—Ä–∏–Ω—è—Ç! –û—Ç–∫–∏–Ω—å—Å—è –Ω–∞ —Å–ø–∏–Ω–∫—É –∫—Ä–µ—Å–ª–∞ –∏ –∂–¥–∏ —Å–ª–µ–¥—É—é—â—É—é –ø–µ—Å–Ω—é üòé");
        }

        async function skip() {
            // –°–∫–∏–ø –≤—Ä–µ–º–µ–Ω–Ω—ã–π ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
            submit("SKIP", "–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ —ç—Ç–æ—Ç —ç—Ç–∞–ø. –ñ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É...");
        }

        async function submit(msg, statusText) {
            toggle(false);
            document.getElementById('status').innerText = statusText;
            const full = `${document.getElementById('lvl-badge').innerText} ${myNick} (${myLogin})`;
            await supabaseClient.from('quiz_chat').insert([{ player_name: full, message: msg }]);
        }

        function toggle(en) {
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ (–Ω–µ —Å–∫–∏–ø), –æ–Ω –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –Ω–æ–≤–æ–π –ø–µ—Å–Ω–∏
            const finalEn = hasAnsweredPermanently ? false : en;
            document.getElementById('sendBtn').disabled = !finalEn;
            document.getElementById('skipBtn').disabled = !finalEn;
        }

        const ch = supabaseClient.channel('quiz_chat');
        ch.on('broadcast', { event: 'sync_state' }, (p) => {
            const sNum = p.payload.songNum;
            document.getElementById('track-val').innerText = sNum;
            document.getElementById('lvl-badge').innerText = p.payload.level;
            if (currentSong !== sNum) {
                currentSong = sNum; hasAnsweredPermanently = false;
                document.getElementById('status').innerText = "–ù–æ–≤–∞—è –ø–µ—Å–Ω—è...";
                document.getElementById('pArtist').value = ""; document.getElementById('pSong').value = "";
            }
            toggle(false);
        })
        .on('broadcast', { event: 'game_paused' }, p => {
            document.getElementById('pause-overlay').style.display = p.payload.paused ? 'flex' : 'none';
        })
        .on('broadcast', { event: 'start_timer' }, p => {
            let left = p.payload.sec;
            document.getElementById('lvl-badge').innerText = p.payload.lvl;
            if (left > 0) {
                toggle(true);
                clearInterval(timerId);
                timerId = setInterval(() => {
                    left--; document.getElementById('player-timer').innerText = left < 10 ? '0'+left : left;
                    if(left <= 0) { clearInterval(timerId); toggle(false); }
                }, 1000);
            } else { clearInterval(timerId); document.getElementById('player-timer').innerText = "00"; toggle(false); }
        }).subscribe();
    </script>
</body>
</html>
