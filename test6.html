<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Admin PRO v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --gold: #D4AF37; --silver: #B0B0B0; --bronze: #A0522D; 
            --dark-bg: #0f0f0f; --panel-bg: #1a1a1a; --text-color: #e0e0e0; 
            --accent: #0078d4; --border: #2d2d2d; --danger: #ef5350; 
            --answered: #163e63; --skipped: #2a2a2a;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-color); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { background: var(--panel-bg); padding: 40px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .login-box input { display: block; width: 250px; padding: 12px; margin: 20px 0; background: #000; border: 1px solid var(--border); color: white; text-align: center; }
        .btn-login { background: var(--accent); color: white; border: none; padding: 12px 24px; cursor: pointer; width: 100%; font-weight: bold; }

        /* TOP BAR */
        .top-bar { height: 55px; background: var(--panel-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 12px; }
        .btn-sm { background: transparent; border: 1px solid #444; color: #ccc; padding: 6px 14px; cursor: pointer; font-size: 12px; text-transform: uppercase; border-radius: 4px; transition: 0.2s; }
        .btn-sm:hover { border-color: var(--accent); color: white; }
        .btn-red { color: var(--danger); border-color: #444; }
        .btn-red:hover { background: var(--danger); color: white; }
        .pause-btn.paused { background: #fbc02d; color: black; border-color: #fbc02d; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        /* HEADER INFO */
        .header-info { height: 120px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid var(--border); background: #111; }
        .track-info { width: 250px; }
        .track-info div { font-size: 14px; color: #888; margin-bottom: 4px; }
        .track-info b { font-size: 24px; color: white; }
        .status-display { flex: 1; text-align: center; font-size: 26px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

        /* TIMER */
        .timer-wrapper { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; }
        .timer-svg { width: 80px; height: 80px; transform: rotate(-90deg); }
        .timer-circle { fill: none; stroke: var(--accent); stroke-width: 5; stroke-dasharray: 251; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .timer-text { position: absolute; font-size: 28px; font-weight: bold; font-family: monospace; }

        /* MAIN LAYOUT */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* LEFT COLUMN */
        .left-panel { width: 320px; border-right: 1px solid var(--border); background: #141414; display: flex; flex-direction: column; }
        .controls-section { padding: 20px; flex: 1; display: flex; flex-direction: column; gap: 20px; }
        .play-buttons { display: flex; justify-content: space-between; width: 100%; }
        .btn-play { width: 85px; height: 85px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); }
        .btn-play span:last-child { font-size: 20px; }
        .btn-play.active { outline: 3px solid white; outline-offset: 2px; }

        .nav-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-nav { padding: 15px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-nav.primary { background: var(--accent); grid-column: span 2; }

        /* INFO TABLE BOTTOM LEFT */
        .info-block { padding: 15px; border-top: 1px solid var(--border); background: #0a0a0a; }
        .info-table { width: 100%; border-collapse: collapse; font-size: 11px; color: #aaa; text-align: left; }
        .info-table th { padding-bottom: 8px; color: #666; text-transform: uppercase; }
        .info-table td { padding: 5px 0; border-top: 1px solid #222; }

        /* TABLE SECTION */
        .table-section { flex: 1; overflow-y: auto; background: var(--panel-bg); }
        .unified-table { width: 100%; border-collapse: collapse; }
        .unified-table th { background: #222; position: sticky; top: 0; padding: 15px 12px; text-align: left; font-size: 12px; color: #777; z-index: 10; border-bottom: 1px solid var(--border); }
        .unified-table td { padding: 10px 12px; border-bottom: 1px solid #252525; }
        
        .player-row.answered { background: var(--answered); }
        .player-row.skipped { opacity: 0.6; background: var(--skipped); }
        .player-row.offline { color: #555; }

        .ans-text { display: block; margin-bottom: 6px; font-weight: 500; }
        .ans-text.hidden-box { background: #000; color: #000; border-radius: 3px; padding: 2px 6px; user-select: none; border: 1px solid #333; }
        .ans-text.hidden-box::after { content: "[ОТВЕТ СКРЫТ]"; color: #444; font-size: 10px; }

        .eval-actions { display: flex; gap: 4px; }
        .btn-eval { padding: 4px 10px; border: none; border-radius: 2px; font-size: 11px; cursor: pointer; color: white; opacity: 0.4; }
        .btn-eval:hover, .btn-eval.selected { opacity: 1; }
        .be-yes { background: #2e7d32; }
        .be-part { background: #f9a825; color: black; }
        .be-undo { background: #555; }

        #settings-overlay { display: none; position: fixed; top: 60px; right: 20px; width: 600px; background: #222; border: 1px solid #444; padding: 20px; z-index: 5000; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
        .settings-table { width: 100%; border-collapse: collapse; }
        .settings-table input { width: 45px; background: #000; border: 1px solid #444; color: white; padding: 4px; text-align: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin:0 0 10px">QUIZ ADMIN <span style="color:var(--accent)">PRO</span></h2>
        <input type="password" id="admin-password" placeholder="Пароль" onkeydown="if(event.key==='Enter') login()">
        <button class="btn-login" onclick="login()">ВОЙТИ</button>
    </div>
</div>

<div class="top-bar">
    <button class="btn-sm" onclick="document.getElementById('excel-file').click()">Загрузить Excel</button>
    <input type="file" id="excel-file" hidden accept=".xlsx, .xls">
    <button class="btn-sm" onclick="toggleSettings()">Настройки</button>
    <button id="btn-pause" class="btn-sm pause-btn" onclick="togglePause()">ПАУЗА</button>
    <div style="flex:1"></div>
    <button class="btn-sm btn-red" onclick="resetGame()">RESET GAME</button>
</div>

<div class="header-info">
    <div class="track-info">
        <div id="track-label">ТЕКУЩИЙ ТРЕК</div>
        <b id="track-counter">Песня 0 / 0</b>
    </div>
    <div class="status-display" id="status-display">ОЖИДАНИЕ</div>
    <div class="timer-wrapper">
        <svg class="timer-svg">
            <circle class="timer-circle" id="timer-circle" cx="40" cy="40" r="38"></circle>
        </svg>
        <div class="timer-text" id="timer-display">00</div>
    </div>
</div>

<div class="main-container">
    <div class="left-panel">
        <div class="controls-section">
            <div class="play-buttons">
                <button id="btn-lvl-0" class="btn-play" style="background:var(--gold)" onclick="manualStart(0)"><span>LEVEL</span><span>1</span></button>
                <button id="btn-lvl-1" class="btn-play" style="background:var(--silver)" onclick="manualStart(1)"><span>LEVEL</span><span>2</span></button>
                <button id="btn-lvl-2" class="btn-play" style="background:var(--bronze)" onclick="manualStart(2)"><span>LEVEL</span><span>3</span></button>
            </div>
            <div class="nav-buttons">
                <button class="btn-nav" onclick="changeTrack(-1)">⏮ ПРЕД</button>
                <button class="btn-nav" onclick="changeTrack(1)">СЛЕД ⏭</button>
                <button class="btn-nav primary" onclick="forceReveal()">ОТКРЫТЬ ОТВЕТ</button>
            </div>
        </div>

        <div class="info-block">
            <table class="info-table">
                <thead><tr><th>Lvl</th><th>Исполн</th><th>Песня</th><th>Комбо</th></tr></thead>
                <tbody id="info-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="table-section">
        <table class="unified-table">
            <thead>
                <tr>
                    <th style="width:20%">ИГРОК</th>
                    <th style="width:10%">ОЧКИ</th>
                    <th style="width:30%">ИСПОЛНИТЕЛЬ</th>
                    <th style="width:30%">ПЕСНЯ</th>
                    <th style="width:10%; text-align:center">ЭТАП</th>
                </tr>
            </thead>
            <tbody id="players-table-body"></tbody>
        </table>
    </div>
</div>

<div id="settings-overlay">
    <h3>Параметры раундов</h3>
    <table class="settings-table">
        <tbody id="settings-tbody"></tbody>
    </table>
    <button class="btn-sm" style="margin-top:15px" onclick="toggleSettings()">Закрыть</button>
</div>

<div id="yt-container" style="display:none"><div id="yt-player"></div></div>

<script>
    const S_URL = 'https://gatadttzyeusozvkwvai.supabase.co';
    const S_KEY = 'sb_publishable_cwXp1mw42C6sDXoeszY8sw_lYrAAefY';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let playlist = [];
    let currentIndex = 0;
    let ytPlayer;
    let players = {}; 
    let onlineUsers = new Set();
    let sortedKeys = []; // Для фиксации порядка

    const DEFAULT_SETTINGS = [
        { dur: 1.5, timer: 23, pArt: 32, pSong: 32, kArt: 0.75, kSong: 0.75, combo: 10 },
        { dur: 5.0, timer: 20, pArt: 24, pSong: 20, kArt: 0.75, kSong: 0.5, combo: 5 },
        { dur: 12.0, timer: 13, pArt: 16, pSong: 8, kArt: 0.75, kSong: 0.25, combo: 0 }
    ];
    let settings = { levels: JSON.parse(JSON.stringify(DEFAULT_SETTINGS)) };

    let activeLevel = -1;
    let currentPhase = 'IDLE';
    let timerId, playTimeout;
    let isPaused = false;
    const TIMER_CIRCLE_C = 251;

    // --- INIT ---
    async function login() {
        const pass = document.getElementById('admin-password').value;
        const { data } = await supabaseClient.from('quiz_users').select('password').eq('username', 'admin').single();
        if (data?.password === pass) {
            document.getElementById('login-screen').style.display = 'none';
            sessionStorage.setItem('quiz_authorized', 'true');
            initApp();
        } else alert('Ошибка');
    }

    if (sessionStorage.getItem('quiz_authorized') === 'true') {
        document.getElementById('login-screen').style.display = 'none';
        initApp();
    }

    async function initApp() {
        await loadSettings();
        await restoreState();
        updateInfoTable();
        renderSettings();
        refreshSortedKeys();
        renderTable();
    }

    // --- YOUTUBE ---
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('yt-player', {
            height: '1', width: '1',
            events: { 'onStateChange': onPlayerStateChange }
        });
    }

    function onPlayerStateChange(e) {
        if (e.data == YT.PlayerState.PLAYING && currentPhase === 'PRELOAD') {
            currentPhase = 'PLAYING';
            updateStatus("ПРИЕМ ОТВЕТОВ...");
            const cfg = settings.levels[activeLevel];
            const totalTime = Math.ceil(cfg.dur) + cfg.timer;
            broadcastTimer(totalTime, `Уровень ${activeLevel+1}`);
            startInternalTimer(totalTime);
            playTimeout = setTimeout(() => { ytPlayer.pauseVideo(); }, cfg.dur * 1000);
        }
    }

    // --- LOGIC ---
    function manualStart(lvl) {
        if(isPaused) togglePause();
        startLevelSequence(lvl);
    }

    async function startLevelSequence(lvl) {
        if (!playlist[currentIndex]) return;
        stopLogic();
        activeLevel = lvl;
        currentPhase = 'PRELOAD';
        highlightLevelBtn(lvl);
        
        const row = playlist[currentIndex];
        const vid = extractVideoId(row[0] || "");
        const startSec = parseFloat(row[3 + lvl]) || 0;
        const cfg = settings.levels[lvl];

        broadcastState(currentIndex + 1, playlist.length, `Уровень ${lvl+1}`, cfg);

        // Оптимизация: если видео то же самое, просто мотаем
        const currentVid = ytPlayer.getVideoData?.()?.video_id;
        if (currentVid === vid) {
            ytPlayer.seekTo(startSec);
            ytPlayer.playVideo();
        } else {
            ytPlayer.loadVideoById({ videoId: vid, startSeconds: startSec });
        }
    }

    function checkAutoProgress() {
        const pList = Object.keys(players);
        if (pList.length === 0) return;

        let answeredCount = 0;
        let finishedCount = 0; // ответили или скипнули

        pList.forEach(k => {
            const rd = players[k].roundData;
            if (rd.stage !== null) { answeredCount++; finishedCount++; }
            else if (rd.isSkipped) { finishedCount++; }
        });

        // ПРАВИЛО 1: Все ответили (без скипов) -> Сразу ответ
        if (answeredCount >= pList.length) {
            forceReveal();
        } 
        // ПРАВИЛО 2: Все закончили (ответы + скипы) -> След этап или ответ
        else if (finishedCount >= pList.length) {
            if (activeLevel < 2 && activeLevel !== -1) {
                startLevelSequence(activeLevel + 1);
            } else {
                forceReveal();
            }
        }
    }

    function forceReveal() {
        stopLogic();
        currentPhase = 'REVEALED';
        activeLevel = -1;
        highlightLevelBtn(-1);
        broadcastTimer(0, "");
        const row = playlist[currentIndex];
        updateStatus(`${row[1]} — ${row[2]}`);
        renderTable();
    }

    async function changeTrack(dir) {
        if (dir === 1) commitScores(); // Сохраняем баллы перед уходом
        
        let n = currentIndex + dir;
        if (n < 0 || n >= playlist.length) return;

        stopLogic();
        currentIndex = n;
        activeLevel = -1;
        
        // Очистка чата без ошибки 400
        await supabaseClient.from('quiz_chat').delete().neq('player_name', '_');

        refreshSortedKeys(); // Сортируем ТОЛЬКО здесь
        updateTrackDisplay();
        updateStatus("ОЖИДАНИЕ");
        saveGlobalState();
        renderTable();

        if (dir === 1) manualStart(0); // Автоплей первого этапа
    }

    function commitScores() {
        Object.keys(players).forEach(login => {
            const p = players[login];
            const rd = p.roundData;
            let roundPts = (rd.artScore || 0) + (rd.songScore || 0);
            if (rd.stage !== null && rd.artScore > 0 && rd.songScore > 0) {
                roundPts += settings.levels[rd.stage].combo;
            }
            p.totalScore = Number((p.totalScore + roundPts).toFixed(1));
            p.roundData = { artAns: null, songAns: null, stage: null, isSkipped: false, artScore: 0, songScore: 0 };
        });
    }

    // --- UI RENDER ---
    function refreshSortedKeys() {
        sortedKeys = Object.keys(players).sort((a,b) => {
            const getS = (p) => p.totalScore + (p.roundData.artScore||0) + (p.roundData.songScore||0);
            return getS(players[b]) - getS(players[a]);
        });
    }

    function renderTable() {
        const tbody = document.getElementById('players-table-body');
        tbody.innerHTML = '';

        sortedKeys.forEach(login => {
            const p = players[login];
            if (!p) return;
            const rd = p.roundData;
            const isOnline = onlineUsers.has(login);
            const isRevealed = (currentPhase === 'REVEALED');
            
            const tr = document.createElement('tr');
            tr.className = `player-row ${rd.stage!==null?'answered':''} ${rd.isSkipped?'skipped':''} ${!isOnline?'offline':''}`;

            const cfg = settings.levels[rd.stage !== null ? rd.stage : 0];
            const as = rd.artScore || 0;
            const ss = rd.songScore || 0;
            const combo = (rd.stage !== null && as > 0 && ss > 0) ? cfg.combo : 0;
            const displayTotal = Number((p.totalScore + as + ss + combo).toFixed(1));

            const mask = (text, shown) => {
                if (!text) return '<span class="ans-text">---</span>';
                if (shown || isRevealed) return `<span class="ans-text">${text}</span>`;
                return `<span class="ans-text hidden-box"></span>`;
            };

            tr.innerHTML = `
                <td><b style="font-size:15px">${login}</b></td>
                <td><input type="number" value="${displayTotal}" class="btn-sm" style="width:65px; color:var(--gold); font-weight:bold; text-align:center" onchange="manualScore('${login}', this.value)"></td>
                <td>
                    ${mask(rd.artAns, false)}
                    ${isRevealed && rd.stage !== null ? genEval(login, 'art', cfg.pArt, cfg.kArt, as) : ''}
                </td>
                <td>
                    ${mask(rd.songAns, false)}
                    ${isRevealed && rd.stage !== null ? genEval(login, 'song', cfg.pSong, cfg.kSong, ss) : ''}
                </td>
                <td style="text-align:center; font-weight:bold">${rd.stage !== null ? rd.stage + 1 : (rd.isSkipped ? 'SKIP' : '-')}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function genEval(login, type, max, k, current) {
        const part = Number((max * k).toFixed(1));
        return `
            <div class="eval-actions">
                <button class="btn-eval be-yes ${current===max?'selected':''}" onclick="setScore('${login}','${type}',${max})">${max}</button>
                <button class="btn-eval be-part ${current===part?'selected':''}" onclick="setScore('${login}','${type}',${part})">${part}</button>
                <button class="btn-eval be-undo" onclick="setScore('${login}','${type}',0)">0</button>
            </div>`;
    }

    // --- CORE HELPERS ---
    function stopLogic() {
        clearTimeout(playTimeout);
        clearInterval(timerId);
        if(ytPlayer?.pauseVideo) ytPlayer.pauseVideo();
        updateTimerVisual(0, 1);
    }

    function startInternalTimer(sec) {
        clearInterval(timerId);
        let left = sec;
        updateTimerVisual(left, sec);
        timerId = setInterval(() => {
            if(isPaused) return;
            left--;
            updateTimerVisual(left, sec);
            if(left <= 0) { clearInterval(timerId); checkAutoProgress(); }
        }, 1000);
    }

    function updateTimerVisual(v, m) {
        document.getElementById('timer-display').innerText = v < 10 ? '0'+v : v;
        const offset = m > 0 ? TIMER_CIRCLE_C - (v/m)*TIMER_CIRCLE_C : TIMER_CIRCLE_C;
        document.getElementById('timer-circle').style.strokeDashoffset = offset;
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('btn-pause').classList.toggle('paused', isPaused);
        if (isPaused) ytPlayer.pauseVideo();
        else if (currentPhase === 'PLAYING') ytPlayer.playVideo();
        supabaseClient.channel('quiz_chat').send({ type:'broadcast', event:'game_paused', payload:{paused:isPaused}});
    }

    function setScore(login, type, val) {
        if (type === 'art') players[login].roundData.artScore = val;
        else players[login].roundData.songScore = val;
        renderTable();
        saveGlobalState();
    }

    function manualScore(login, val) {
        players[login].totalScore = parseFloat(val);
        players[login].roundData.artScore = 0;
        players[login].roundData.songScore = 0;
        saveGlobalState();
    }

    function updateInfoTable() {
        const b = document.getElementById('info-tbody');
        b.innerHTML = settings.levels.map((l, i) => `
            <tr><td>${i+1}</td><td>${l.pArt} (x${l.kArt})</td><td>${l.pSong} (x${l.kSong})</td><td>+${l.combo}</td></tr>
        `).join('');
    }

    function updateStatus(t) { document.getElementById('status-display').innerText = t; }
    function updateTrackDisplay() { 
        document.getElementById('track-counter').innerText = `Песня ${playlist.length ? currentIndex+1 : 0} / ${playlist.length}`; 
    }
    function highlightLevelBtn(lvl) {
        document.querySelectorAll('.btn-play').forEach(b => b.classList.remove('active'));
        if (lvl >= 0) document.getElementById(`btn-lvl-${lvl}`).classList.add('active');
    }
    function broadcastTimer(sec, lvl) {
        supabaseClient.channel('quiz_chat').send({ type:'broadcast', event:'start_timer', payload:{sec, lvl}});
    }
    function broadcastState(num, total, lvl, cfg) {
        supabaseClient.channel('quiz_chat').send({ type:'broadcast', event:'sync_state', payload: {
            songNum: num, totalSongs: total, level: lvl, 
            points: { art: cfg.pArt, sng: cfg.pSong, kArt: cfg.kArt, kSng: cfg.kSong, cmb: cfg.combo }
        }});
    }

    function extractVideoId(u) { return u.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1]; }

    // --- SUPABASE REALTIME ---
    supabaseClient.channel('quiz_chat')
    .on('presence', { event: 'sync' }, () => {
        const state = supabaseClient.channel('quiz_chat').presenceState();
        onlineUsers.clear();
        for (const id in state) {
            state[id].forEach(p => {
                const login = p.user;
                if (!login) return;
                onlineUsers.add(login);
                if (!players[login]) {
                    players[login] = { totalScore: 0, lastSeen: Date.now(), roundData: { artAns: null, songAns: null, stage: null, isSkipped: false, artScore: 0, songScore: 0 } };
                    refreshSortedKeys();
                }
            });
        }
        renderTable();
    })
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'quiz_chat' }, payload => {
        const d = payload.new;
        const login = d.player_name.split(' ').slice(2).join(' ') || d.player_name;
        if (!players[login]) return;

        if (d.message === "SKIP") {
            players[login].roundData.isSkipped = true;
        } else {
            const [art, sng] = d.message.split(' | ');
            players[login].roundData.artAns = art;
            players[login].roundData.songAns = sng;
            players[login].roundData.stage = activeLevel;
            players[login].roundData.isSkipped = false;
        }
        renderTable();
        checkAutoProgress();
    }).subscribe();

    // --- SETTINGS & PERSISTENCE ---
    function toggleSettings() {
        const s = document.getElementById('settings-overlay');
        s.style.display = s.style.display === 'block' ? 'none' : 'block';
    }

    function renderSettings() {
        const b = document.getElementById('settings-tbody');
        b.innerHTML = '<tr><th>Lvl</th><th>Длит</th><th>Таймер</th><th>Очки И</th><th>Очки П</th><th>К-И</th><th>К-П</th><th>Cmb</th></tr>';
        settings.levels.forEach((l, i) => {
            b.innerHTML += `<tr>
                <td>${i+1}</td>
                <td><input type="number" step="0.5" value="${l.dur}" onchange="updateSet(${i},'dur',this.value)"></td>
                <td><input type="number" value="${l.timer}" onchange="updateSet(${i},'timer',this.value)"></td>
                <td><input type="number" value="${l.pArt}" onchange="updateSet(${i},'pArt',this.value)"></td>
                <td><input type="number" value="${l.pSong}" onchange="updateSet(${i},'pSong',this.value)"></td>
                <td><input type="number" step="0.1" value="${l.kArt}" onchange="updateSet(${i},'kArt',this.value)"></td>
                <td><input type="number" step="0.1" value="${l.kSong}" onchange="updateSet(${i},'kSong',this.value)"></td>
                <td><input type="number" value="${l.combo}" onchange="updateSet(${i},'combo',this.value)"></td>
            </tr>`;
        });
    }

    function updateSet(i, k, v) { settings.levels[i][k] = parseFloat(v); saveSettings(); updateInfoTable(); }
    async function saveSettings() { await supabaseClient.from('quiz_settings').upsert({ id: 1, json_data: settings }); }
    async function loadSettings() {
        const { data } = await supabaseClient.from('quiz_settings').select('json_data').eq('id', 1).single();
        if (data) settings = data.json_data;
    }

    async function saveGlobalState() {
        const payload = { id: 1, playlist, scores: players, current_index: currentIndex };
        await supabaseClient.from('quiz_state').upsert(payload);
    }

    async function restoreState() {
        const { data } = await supabaseClient.from('quiz_state').select('*').eq('id', 1).single();
        if (data) {
            if (data.playlist) playlist = data.playlist;
            currentIndex = data.current_index || 0;
            if (data.scores) players = data.scores;
            updateTrackDisplay();
        }
    }

    function resetGame() { if(confirm("Сбросить всё?")) location.reload(); }

    document.getElementById('excel-file').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = ev => {
            const wb = XLSX.read(ev.target.result, { type: 'binary' });
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
            playlist = raw.filter(r => r[0]?.toString().includes('http'));
            currentIndex = 0;
            updateTrackDisplay();
            saveGlobalState();
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

</script>
<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
