<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∫–∞ - Quiz Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --gold: #D4AF37; --silver: #B0B0B0; --bronze: #A0522D; --dark-bg: #121212; --panel-bg: #1e1e1e; --text-color: #ffffff; --accent: #0078d4; --border: #333333; --danger: #c62828; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--dark-bg); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –°–µ—Ç–∫–∞ */
        .game-section { width: 70%; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid var(--border); position: relative; }
        .players-section { width: 30%; padding: 20px; background-color: var(--panel-bg); display: flex; flex-direction: column; overflow-y: auto; }
        
        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .upload-area { position: absolute; top: 20px; left: 20px; display: flex; gap: 10px; }
        .top-right-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
        .btn-action { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; cursor: pointer; font-size: 12px; text-transform: uppercase; transition: 0.2s; }
        .btn-action:hover { background: var(--accent); color: white; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        
        /* –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã */
        #track-counter { font-size: 24px; color: #888; margin-bottom: 5px; }
        #timer-display { font-size: 140px; font-weight: 200; margin-bottom: 10px; font-family: monospace; color: var(--accent); }
        .play-row { display: flex; gap: 15px; margin-bottom: 30px; }
        .btn-main { width: 100px; height: 100px; border-radius: 50%; border: none; cursor: pointer; font-weight: bold; font-size: 16px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: 0.3s; }
        .btn-main:active { transform: scale(0.9); }
        .gold { background: var(--gold); } .silver { background: var(--silver); } .bronze { background: var(--bronze); } .full-play { background: var(--accent); }
        
        #answer-box { font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 15px; min-height: 40px; color: var(--gold); }
        .nav-row { display: flex; gap: 10px; }
        .btn-nav { padding: 10px 20px; background: #333; color: #fff; border: none; cursor: pointer; font-size: 18px; border-radius: 4px; }

        /* –ò–≥—Ä–æ–∫–∏ */
        .player-row { display: flex; align-items: center; justify-content: space-between; background: #252525; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid var(--accent); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .player-info { flex: 1; }
        .player-name-text { font-size: 16px; font-weight: bold; display: block; }
        .player-login-text { font-size: 11px; color: #666; }
        .score-input { width: 65px; background: #000; border: 1px solid #444; color: var(--gold); padding: 5px; text-align: center; font-size: 18px; font-weight: bold; border-radius: 4px; margin-right: 10px; }
        .btn-del { background: none; border: none; color: #444; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-del:hover { color: var(--danger); }

        /* –ß–∞—Ç-–±–∞—Ä—ã (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è) */
        #chat-sidebar { position: fixed; left: 20px; bottom: 20px; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .chat-bar { background: #1e1e1e; border: 2px solid var(--accent); color: white; padding: 12px; border-radius: 8px; width: 200px; pointer-events: auto; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .chat-bar.open { width: 360px; }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        #settings-panel { position: absolute; bottom: 20px; width: 90%; background: #1a1a1a; border: 1px solid #444; padding: 15px; display: none; z-index: 100; }
        .settings-table { width: 100%; color: #ccc; font-size: 12px; border-collapse: collapse; }
        .settings-table input { width: 40px; background: #000; color: #fff; border: 1px solid #333; text-align: center; }
    </style>
</head>
<body>

<div id="chat-sidebar"></div>

<div class="game-section">
    <div class="upload-area">
        <input type="file" id="excel-file" hidden accept=".xlsx, .xls">
        <button class="btn-action" onclick="document.getElementById('excel-file').click()">–§–∞–π–ª</button>
        <button class="btn-action" onclick="loadFromGSheets()">Google CSV</button>
        <input type="text" id="gsheets-url" style="display:none;" value="">
    </div>

    <div class="top-right-actions">
        <button class="btn-action btn-danger" onclick="clearAllCache()">–°–±—Ä–æ—Å –ö—ç—à–∞</button>
        <button class="btn-action" onclick="toggleSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div id="track-counter">–ü–µ—Å–Ω—è 0/0</div>
    <div id="timer-display">00</div>
    
    <div class="play-row">
        <button class="btn-main gold" onclick="handlePlay(0)">LVL 1</button>
        <button class="btn-main silver" onclick="handlePlay(1)">LVL 2</button>
        <button class="btn-main bronze" onclick="handlePlay(2)">LVL 3</button>
        <button class="btn-main full-play" onclick="handlePlay(3)">LIVE</button>
    </div>

    <div id="answer-box">******</div>

    <div class="nav-row">
        <button class="btn-nav" onclick="changeTrack(-1)">‚èÆ</button>
        <button id="toggle-ans-btn" class="btn-nav" style="background: var(--accent); font-size: 14px; width: 150px;" onclick="toggleAnswer()">–û–¢–í–ï–¢</button>
        <button class="btn-nav" onclick="changeTrack(1)">‚è≠</button>
    </div>

    <div id="settings-panel">
        <table class="settings-table">
            <thead>
                <tr><th>LVL</th> <th>–°–µ–∫.</th> <th>–¢–∞–π–º–µ—Ä</th> <th>–ê—Ä—Ç.</th> <th>–ü–µ—Å–Ω—è</th> <th>‚ö†Ô∏è%</th> <th>Combo</th></tr>
            </thead>
            <tbody id="settings-body">
                <tr id="row-lvl-0"><td>1</td><td><input type="number" step="0.1" class="set-dur" value="1.5"></td><td><input type="number" class="set-timer" value="20"></td><td><input type="number" class="set-pArt" value="4"></td><td><input type="number" class="set-pSong" value="4"></td><td><input type="number" step="0.1" class="set-debuff" value="0.5"></td><td><input type="number" class="set-combo" value="2"></td></tr>
                <tr id="row-lvl-1"><td>2</td><td><input type="number" step="0.1" class="set-dur" value="5.0"></td><td><input type="number" class="set-timer" value="25"></td><td><input type="number" class="set-pArt" value="2"></td><td><input type="number" class="set-pSong" value="2"></td><td><input type="number" step="0.1" class="set-debuff" value="0.5"></td><td><input type="number" class="set-combo" value="1"></td></tr>
                <tr id="row-lvl-2"><td>3</td><td><input type="number" step="0.1" class="set-dur" value="12.0"></td><td><input type="number" class="set-timer" value="30"></td><td><input type="number" class="set-pArt" value="1"></td><td><input type="number" class="set-pSong" value="1"></td><td><input type="number" step="0.1" class="set-debuff" value="0.5"></td><td><input type="number" class="set-combo" value="0.5"></td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="players-section">
    <h3 style="margin-top:0; color:var(--accent); font-size: 14px; text-transform: uppercase;">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h3>
    <div id="players-list"></div>
</div>

<div id="player-api-container" style="display:none;"><div id="yt-player"></div></div>

<script>
    const S_URL = 'https://gatadttzyeusozvkwvai.supabase.co';
    const S_KEY = 'sb_publishable_cwXp1mw42C6sDXoeszY8sw_lYrAAefY';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let playlist = [], currentIndex = 0, ytPlayer, timerId, playTimeout, currentDuration = 0, isAnswerShown = false;

    window.onload = async () => {
        loadSettingsFromCache();
        loadGameStateFromCache();
        // –°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–∑–∏–º –∏–∑ –±–∞–∑—ã, –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –∏–∑ –∫—ç—à–∞
        await syncPlayersFromDB(); 
        document.getElementById('settings-body').addEventListener('input', saveSettingsToCache);
    };

    // --- –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø ---
    function saveSettingsToCache() {
        const s = [];
        for(let i=0; i<3; i++) {
            const r = document.getElementById(`row-lvl-${i}`);
            s.push({ dur: r.querySelector('.set-dur').value, timer: r.querySelector('.set-timer').value, art: r.querySelector('.set-pArt').value, song: r.querySelector('.set-pSong').value, debuff: r.querySelector('.set-debuff').value, combo: r.querySelector('.set-combo').value });
        }
        localStorage.setItem('quiz_settings', JSON.stringify(s));
    }

    function loadSettingsFromCache() {
        const cached = localStorage.getItem('quiz_settings');
        if(cached) {
            JSON.parse(cached).forEach((s, i) => {
                const r = document.getElementById(`row-lvl-${i}`);
                if(r) { r.querySelector('.set-dur').value = s.dur; r.querySelector('.set-timer').value = s.timer; r.querySelector('.set-pArt').value = s.art; r.querySelector('.set-pSong').value = s.song; r.querySelector('.set-debuff').value = s.debuff; r.querySelector('.set-combo').value = s.combo; }
            });
        }
    }

    function saveGameStateToCache() {
        localStorage.setItem('quiz_current_index', currentIndex);
        localStorage.setItem('quiz_playlist', JSON.stringify(playlist));
    }

    function loadGameStateFromCache() {
        const cIdx = localStorage.getItem('quiz_current_index');
        const cList = localStorage.getItem('quiz_playlist');
        if(cList) playlist = JSON.parse(cList);
        if(cIdx) currentIndex = parseInt(cIdx);
        updateTrackDisplay();
    }

    function clearAllCache() {
        if(confirm("–ü–û–õ–ù–´–ô –°–ë–†–û–°? –û—á–∫–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) {
            localStorage.clear();
            supabaseClient.from('quiz_leaderboard').delete().neq('login', '0');
            location.reload();
        }
    }

    // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ì–†–û–ö–ê–ú–ò ---
    async function syncPlayersFromDB() {
        const { data } = await supabaseClient.from('quiz_leaderboard').select('*');
        if (data && data.length > 0) {
            document.getElementById('players-list').innerHTML = '';
            data.forEach(p => renderPlayerRow(p.login, p.nickname, p.score));
        } else {
            const cached = localStorage.getItem('quiz_leaderboard');
            if(cached) JSON.parse(cached).forEach(p => renderPlayerRow(p.login, p.nickname, p.score));
        }
    }

    async function updateDBScore(login, nickname, score) {
        await supabaseClient.from('quiz_leaderboard').upsert({ login, nickname, score });
        saveLeaderboardToCache();
    }

    function saveLeaderboardToCache() {
        const players = [];
        document.querySelectorAll('.player-row').forEach(row => {
            players.push({ login: row.id.replace('row-user-', ''), nickname: row.querySelector('.player-name-text').innerText, score: parseFloat(row.dataset.score) });
        });
        localStorage.setItem('quiz_leaderboard', JSON.stringify(players));
    }

    function renderPlayerRow(login, nickname, score = 0) {
        const list = document.getElementById('players-list');
        if (document.getElementById(`row-user-${login}`)) return;
        const html = `
            <div class="player-row" id="row-user-${login}" data-score="${score}">
                <div class="player-info">
                    <span class="player-name-text">${nickname}</span>
                    <span class="player-login-text">@${login}</span>
                </div>
                <input type="number" class="score-input" value="${score}" id="score-${login}" onchange="manualScore('${login}', this.value)">
                <button class="btn-del" onclick="deletePlayer('${login}')">üóë</button>
            </div>`;
        list.insertAdjacentHTML('beforeend', html);
        sortPlayers();
    }

    async function deletePlayer(login) {
        if(confirm(`–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ @${login}?`)) {
            document.getElementById(`row-user-${login}`)?.remove();
            await supabaseClient.from('quiz_leaderboard').delete().eq('login', login);
            saveLeaderboardToCache();
        }
    }

    function manualScore(login, val) {
        const row = document.getElementById(`row-user-${login}`);
        row.dataset.score = val;
        updateDBScore(login, row.querySelector('.player-name-text').innerText, parseFloat(val));
        sortPlayers();
    }

    function sortPlayers() {
        const list = document.getElementById('players-list');
        const rows = Array.from(list.querySelectorAll('.player-row'));
        rows.sort((a, b) => parseFloat(b.dataset.score) - parseFloat(a.dataset.score));
        rows.forEach(r => list.appendChild(r));
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–û–°–¢–ê–õ–¨–ù–û–ï) ---
    function handleIncomingMessage(data) {
        const rawName = data.player_name;
        const login = rawName.match(/\((.*?)\)/)?.[1] || "unknown";
        const nickname = rawName.split(' (')[0].replace(/LVL\d/, "").trim();
        renderPlayerRow(login, nickname);
        displayChatBar(data, login);
        triggerBeep(880, 0.1);
    }

    function displayChatBar(data, login) {
        const sidebar = document.getElementById('chat-sidebar');
        const safeId = btoa(login).replace(/=/g, "");
        if (document.getElementById(`bar-${safeId}`)) return;

        let lvl = data.player_name.includes("LVL2") ? 1 : (data.player_name.includes("LVL3") ? 2 : 0);
        const parts = data.message.split(' | ');
        const art = parts[0] || "---", sng = parts[1] || "---";

        const bar = document.createElement('div');
        bar.className = 'chat-bar';
        bar.id = `bar-${safeId}`;
        bar.dataset.login = login;
        bar.dataset.aEval = "-1"; bar.dataset.sEval = "-1";

        bar.innerHTML = `
            <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">üë§ ${data.player_name}</div>
            <div class="eval-section" style="display:none;">
                <div style="font-size:12px; color:var(--accent)">–ê–†–¢: <b>${art}</b></div>
                <div class="eval-btns" style="display:flex; gap:4px; margin-bottom:10px;">
                    <button class="btn-v" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'art', 1, ${lvl})">–í–µ—Ä–Ω–æ</button>
                    <button class="btn-c" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'art', 0.5, ${lvl})">‚ö†Ô∏è</button>
                    <button class="btn-n" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'art', 0, ${lvl})">‚ùå</button>
                </div>
                <div style="font-size:12px; color:var(--accent)">–ü–ï–°–ù–Ø: <b>${sng}</b></div>
                <div class="eval-btns" style="display:flex; gap:4px;">
                    <button class="btn-v" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'song', 1, ${lvl})">–í–µ—Ä–Ω–æ</button>
                    <button class="btn-c" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'song', 0.5, ${lvl})">‚ö†Ô∏è</button>
                    <button class="btn-n" style="flex:1; padding:10px; border-radius:4px;" onclick="evalAns('${safeId}', 'song', 0, ${lvl})">‚ùå</button>
                </div>
            </div>`;

        bar.onclick = (e) => {
            e.stopPropagation();
            if (e.target.tagName === 'BUTTON') return;
            const isOpen = bar.classList.contains('open');
            document.querySelectorAll('.chat-bar.open').forEach(b => { b.classList.remove('open'); b.querySelector('.eval-section').style.display='none'; });
            if (!isOpen) { bar.classList.add('open'); bar.querySelector('.eval-section').style.display = 'block'; }
        };
        sidebar.appendChild(bar); 
    }

    async function evalAns(safeId, type, mult, lvl) {
        const bar = document.getElementById(`bar-${safeId}`);
        const login = bar.dataset.login;
        const row = document.getElementById(`row-user-${login}`);
        
        const config = document.getElementById(`row-lvl-${lvl}`);
        const base = parseFloat(config.querySelector(type === 'art' ? '.set-pArt' : '.set-pSong').value);
        const debuff = parseFloat(config.querySelector('.set-debuff').value);
        
        let pts = (mult === 1) ? base : (mult === 0.5 ? base * debuff : 0);
        if (type === 'art') bar.dataset.aEval = mult; else bar.dataset.sEval = mult;
        
        let currentScore = parseFloat(row.dataset.score);
        let newScore = (currentScore + pts);
        
        // –ö–æ–º–±–æ
        if (bar.dataset.aEval !== "-1" && bar.dataset.sEval !== "-1") {
            bar.style.borderColor = "var(--gold)";
            if (parseFloat(bar.dataset.aEval) > 0 && parseFloat(bar.dataset.sEval) > 0) {
                newScore += parseFloat(config.querySelector('.set-combo').value);
            }
        }

        row.dataset.score = newScore.toFixed(1);
        row.querySelector('.score-input').value = newScore.toFixed(1);
        
        await updateDBScore(login, row.querySelector('.player-name-text').innerText, parseFloat(newScore.toFixed(1)));
        sortPlayers();
        triggerBeep(1000, 0.05);
    }

    // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ YouTube –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function updateTrackDisplay() {
        document.getElementById('track-counter').innerText = `–ü–µ—Å–Ω—è ${playlist.length > 0 ? currentIndex + 1 : 0}/${playlist.length}`;
        document.getElementById('answer-box').innerText = "******";
        isAnswerShown = false;
        saveGameStateToCache();
    }

    async function changeTrack(dir) {
        if (playlist.length === 0) return;
        let n = currentIndex + dir;
        if (n < 0 || n >= playlist.length) return;
        currentIndex = n;
        supabaseClient.channel('quiz_chat').send({ type: 'broadcast', event: 'start_timer', payload: { sec: 0 } });
        await supabaseClient.from('quiz_chat').delete().neq('id', '00000000-0000-0000-0000-000000000000');
        document.getElementById('chat-sidebar').innerHTML = '';
        updateTrackDisplay();
        ytPlayer?.stopVideo();
    }

    function handlePlay(type) {
        if (!playlist[currentIndex]) return;
        const row = playlist[currentIndex];
        const vid = extractVideoId(row[0].toString());
        let dur, tSec, lp;
        if (type === 3) { dur = 60; tSec = 60; lp = ""; }
        else {
            const conf = document.getElementById(`row-lvl-${type}`);
            dur = parseFloat(conf.querySelector('.set-dur').value);
            tSec = parseInt(conf.querySelector('.set-timer').value);
            lp = `LVL${type + 1} `;
        }
        currentDuration = dur;
        ytPlayer.loadVideoById({ videoId: vid, startSeconds: (type === 3 ? row[2] : row[2+type]) || 0 });
        runTimer(tSec, lp);
    }

    function runTimer(sec, lvl) {
        supabaseClient.channel('quiz_chat').send({ type: 'broadcast', event: 'start_timer', payload: { sec, lvl } });
        clearInterval(timerId);
        let left = sec;
        document.getElementById('timer-display').innerText = left;
        timerId = setInterval(() => {
            left--; document.getElementById('timer-display').innerText = left < 10 ? '0'+left : left;
            if (left <= 0) { clearInterval(timerId); triggerBeep(600, 0.8); }
        }, 1000);
    }

    function toggleAnswer() { 
        if (!playlist[currentIndex]) return;
        isAnswerShown = !isAnswerShown;
        document.getElementById('answer-box').innerText = isAnswerShown ? (playlist[currentIndex][1] || "---") : "******";
    }

    function toggleSettings() { const p = document.getElementById('settings-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    function extractVideoId(url) { const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/); return m ? m[1] : null; }
    function triggerBeep(f, d) { try { const a=new AudioContext(); const o=a.createOscillator(); const g=a.createGain(); o.frequency.value=f; g.gain.exponentialRampToValueAtTime(0.01, a.currentTime+d); o.connect(g); g.connect(a.destination); o.start(); o.stop(a.currentTime+d); } catch(e){} }
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('yt-player', { height: '1', width: '1', playerVars: { 'autoplay': 0, 'controls': 0 },
            events: { 'onStateChange': (e) => { if (e.data == YT.PlayerState.PLAYING) { clearTimeout(playTimeout); playTimeout = setTimeout(() => ytPlayer.pauseVideo(), currentDuration * 1000); }} }
        });
    }

    supabaseClient.channel('quiz_chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'quiz_chat' }, payload => {
        handleIncomingMessage(payload.new);
    }).subscribe();

    async function loadFromGSheets() {
        const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ CSV —Ñ–∞–π–ª:");
        if (!url) return;
        try { 
            const r = await fetch(url); const t = await r.text(); 
            const wb = XLSX.read(t, {type:'string'});
            processData(wb);
        } catch(e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); }
    }

    function processData(wb) {
        const sheet = wb.Sheets[wb.SheetNames[0]];
        playlist = XLSX.utils.sheet_to_json(sheet, {header:1}).filter(r => r[0] && r[0].toString().includes('http'));
        currentIndex = 0;
        updateTrackDisplay();
    }
</script>
<script src="https://www.youtube.com/iframe_api"></script>
</body>
</html>
